#!/usr/bin/env bash

error() {
	echo -n "ERROR: "
	for msg in "$@"; do echo -e "$msg"; done
	exit 1
}

jarvis-dir() {
	local dir=$(pwd)
	cd -P .
	while [ ! -d '.jarvis' ]; do
		cd ..
		[ $(pwd) != '/' ] ||
			error 'JARVIS has not been initialized.' \
				'You can initialize JARVIS by running "'$0' init".'
	done &&
	echo $(pwd)'/.jarvis'
	cd $dir
}

tasks-dir() {
	echo $(jarvis-dir)/tasks
}

db() {
	[ "$1" ] || error 'SQL not specified!'
	sqlite3 $(jarvis-dir)/jarvis.db "$@"
}

init() {
	[ -e '.jarvis' ] &&
	error 'Initialization failed.' '".jarvis" already exists.'
	mkdir -p .jarvis/tasks
	db "CREATE TABLE tasks(id INTEGER PRIMARY KEY, name, task, args)"
}

which-task() {
	[ $1 ] || error 'Please specify a task.' 'Usage: '$0' which <task>'
	local task=$(tasks-dir)/$1
	[ -x "$task" ] ||
		error 'JARVIS does not know how to "'$1'".'
	echo $task
}

perform() {
	while getopts :n: opt; do
		case $opt in
		n) local name=$OPTARG ;;
		\?) error 'Illegal option: -'$OPTARG \
				'Usage: '$0' [-n <name>] <task> [arguments]...' ;;
		esac
	done
	shift $((OPTIND-1))
	local task=$1
	shift
	db "INSERT INTO tasks(name, task, args) VALUES('$name', '$task', '$*')"
}

execute() {
	while true; do
		task=$(db -line 'SELECT * FROM tasks WHERE id = (SELECT MIN(id) FROM tasks)' | sed 's/ //g')
		[ "$task" ] || break;
		for var in $task; do eval "local $var"; done;
		$(which-task $task) $args
		db "DELETE FROM tasks WHERE id = $id"
	done
}

case "$1" in
'') error 'No task to do.' \
		'Usage: '$0' (init | which | <task>) [arguments]...' ;;
init) init ;;
which) which-task $2 ;;
__exec) execute ;;
*) perform $@ ;;
esac
