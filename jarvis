#!/usr/bin/env bash

error() {
	echo -n "ERROR: "
	for msg in "$@"; do echo -e "$msg" >&2; done
	exit 1
}

jarvis-dir() {
	local dir=$(pwd)
	cd -P .
	while [ ! -d '.jarvis' ]; do
		cd ..
		[ $(pwd) != '/' ] ||
			error 'JARVIS has not been initialized.' \
				'You can initialize JARVIS by running "'$0' init".'
	done &&
	echo $(pwd)'/.jarvis'
	cd $dir
}

db() {
	[ "$1" ] || error 'SQL not specified!'
	dbfile=$(jarvis-dir)/jarvis.db || exit 1
	sqlite3 "$dbfile" "$@"
}

init() {
	[ -e '.jarvis' ] &&
		error 'Initialization failed.' '".jarvis" already exists.'
	mkdir -p .jarvis
	db "CREATE TABLE tasks(id INTEGER PRIMARY KEY, task_group, cmd)"
}

perform() {
	while getopts :g: opt; do
		case $opt in
		g) local group=$OPTARG ;;
		\?) error 'Illegal option: -'$OPTARG \
				'Usage: '$0' [-g <group>] <cmd> [arguments]...' ;;
		esac
	done
	shift $((OPTIND-1))
	db "INSERT INTO tasks(task_group, cmd) VALUES('$group', '$*')"
}

execute-task() {
	read id group cmd || error 'Could not read task'
	echo "Execute #$id ($group) $cmd"
}

execute() {
	db -line 'SELECT * FROM tasks WHERE id = (SELECT MIN(id) FROM tasks)' | execute-task
}

case "$1" in
'') error 'No task to do.' \
		'Usage: '$0' (init | which | <task>) [arguments]...' ;;
init) init ;;
__exec) execute ;;
*) perform $@ ;;
esac
